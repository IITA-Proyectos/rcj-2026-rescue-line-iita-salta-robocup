<!-- AUTO-GENERATED FILE – DO NOT EDIT.
     Source: docs/es (Spanish is source of truth)
     This file is generated by GitHub Actions.
-->

# Strategic and Code Analysis: Rescue Logic (Teensy)

> **Author:** Ai Gemini - **Requested by:** Gustavo Viollaz  
> **Date:** 2026-02-23 (America/Argentina/Salta)  
> **Focus:** State Machine Vulnerabilities, Sensor Failures, and Edge Cases.

This document critically evaluates the Teensy code section dedicated to the Rescue Zone (`rutina == "rescate"`), contrasting the programmed logic with the hostile conditions of the international RoboCup Junior Rescue Line regulations.

---

## 1. Integrated Strategy (RPi + Teensy) and Implicit Logic

The current robot paradigm assumes that the **Raspberry Pi has perfect vision** and that **the physics of the environment is ideal**.  
- The Teensy is completely subordinate to the commands of the RPi (`green_state`).
- When the RPi detects a ball (e.g. `green_state == 6`), the Teensy enters a **blind and blocking collection sequence** of approximately 8 seconds.
- The orientation and deposit are based on absolute turns (e.g. `runAngle(180)`), assuming that the deposit zone will always be directly behind it.

---

## 2. Failure Cases in the Real Environment (Edge Cases)

The current design is very fragile against the variations that judges introduce on the track:

### A. False Balls and Glare (Dazzling Light)
*   **The Problem:** Sunlight or LED lights can create silver reflections on the floor or white walls. If the RPi is dazzled and emits a false positive (`green_state = 6`), the Teensy will stop the robot and execute a collection "in the air."
*   **Impact:** The robot loses 10 vital seconds. If this repeats, the `ball_counter` will falsely increase to 3, forcing the robot to attempt to deposit ghost balls, losing evacuation points.
*   **Suggested Solution:** **Touch/Proximity Detection.** Before closing the claw, the Teensy must confirm the camera reading by checking if the ToF sensor or the ultrasonic sensor sees a physical object within 10 cm.

### B. Debris and Loss of Traction
*   **The Problem:** When catching the ball, the code executes `runDistance(30, FORWARD, 8)`. If the robot steps on the debris from the regulations, the wheels will slip.
*   **Impact:** The motors spin, the encoders count pulses, and the software believes it has moved 8 cm, but the robot did not physically move. The claw will close *before* reaching the ball, pushing it away.
*   **Suggested Solution:** Fusion of Encoders + IMU to ensure actual movement, or advance until a collision sensor or the ToF indicates zero distance with the ball.

### C. Obstacles within the Rescue Zone
*   **The Problem:** The block `while (rutina == "rescate")` simply injects speed and direction: `robot.steer(speed, FORWARD, steer)`.
*   **Impact:** If there is an obstacle (black brick) between the robot and the ball, the robot will crash into it head-on.
*   **Suggested Solution:** The Teensy should use its ultrasonic sensors in interrupt mode. If `front_distance < 10` and the camera does not report a ball, the robot should abort the advance and navigate around the obstacle.

### D. Random Entry and Exit Positions
*   **The Problem:** Upon reaching 3 balls, the robot executes `runAngle(20, FORWARD, 180)` and backs up to deposit.
*   **Impact:** The regulations allow square rescue zones where the entry is in the "South" and the deposit zone is in the "East." Turning 180° always assumes a symmetrical scenario (South-North). The robot will deposit the balls against an empty wall.
*   **Suggested Solution:** The RPi should visually search for the red/green triangle of the deposit zone and guide the Teensy dynamically, instead of using rigid coded routines.

---

## 3. Sensor Failure Analysis (Single Points of Failure)

What happens when the hardware fails in the middle of the competition?

1.  **Gyroscope Failure (BNO055):** 
    - In the `runAngle()` function, the code relies on a `while(true)` checking if the angular `error` is less than 1.0. If the I2C bus hangs due to static or a loose cable, the BNO055 stops updating `event.orientation.x`. The error will never reach zero and **the robot will freeze forever** (Infinite Loop).
    - **Fix:** Add an emergency timeout (`if (steertimer > 5000) break;`).
2.  **Front Distance Sensor Failure:**
    - In line 641, during the deposit phase, the robot enters a loop: `while(digitalRead(32) == 0) { if(!alineado && front_distance < 12) ... }`.
    - If the Echo/Trig cable of the ultrasonic sensor is cut, `front_distance` will erratically return 0 or get stuck at infinity. The robot will never consider that it has reached the wall, smashing the claw against the wood.
    - **Fix:** Validate using the impact detected by the accelerometer (sharp spikes in X/Y).

---

## 4. Line-by-Line Code Audit (Critical Fragments of `main.cpp`)

| Lines | Function / Block | Technical Critique |
| :--- | :--- | :--- |
| **250-325** | `runAngle()` | Lacks *Timeout*. It is the most dangerous function of the robot. If the wheels get stuck against the wall and the robot cannot physically turn, the motors will burn out and the program will not advance to the next state. |
| **328-369** | `runDistance()` | `while (fr.pulseCount <= encoder)`. If a wheel gets mechanically stuck (e.g. hair tangled in the axle), the encoder will not count pulses. The robot gets stuck in an infinite loop. A watchdog timer is missing. |
| **569-588** | Sequence `green_state == 6` | It is entirely built with successive calls to `delay(1000)`. While this occurs, the robot becomes blind, deaf, and cannot process new commands from the Raspberry Pi (the UART buffer overflows). |
| **604-608** | Logic `ball_counter>= 3` | Inflexible. If the robot failed a capture attempt, the counter still increased. The robot will think it has a full belly and will go to deposit non-existent balls too early. |
| **634-645** | `alineado=false` | Attempt to align against the wall using simple ultrasonics. Very vulnerable to the angle of incidence of sound; if the robot collides at 45°, the ultrasonic will bounce in another direction and read maximum distance, failing the alignment. |

---
*This analysis highlights the need to transition from a "sequential script" to an "event-driven reactive system" to ensure the robot's invulnerability in international competitions.*