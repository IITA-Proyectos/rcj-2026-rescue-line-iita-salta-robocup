<!-- AUTO-GENERATED FILE â€“ DO NOT EDIT.
     Source: docs/es (Spanish is source of truth)
     This file is generated by GitHub Actions.
-->

# Communication between the Raspberry Pi and the Teensy

This documentation is based on the actual code:
- Raspberry: `rpi/final_rpi/Main.py`
- Teensy: `src/main.cpp`

## Quick Summary

- **Medium**: serial via UART.
- **Baud rate**: 115200.
- **Raspberry**: `/dev/serial0`.
- **Teensy**: `Serial5`.
- **Format**: simple byte protocol with markers (255, 254, 253, 252).

## Protocol from Raspberry -> Teensy

The Raspberry sends a frame of 8 bytes, always in the same order:

```text
[255, speed, 254, angle, 253, green_state, 252, silver_line]
```

Meaning:
- `speed`: 0 to 100. On Teensy it is interpreted as a percentage (see `serialEvent5`).
- `angle`: 0 to 180. Teensy converts it to `steer` in the range [-1, 1] with `(angle - 90) / 90`.
- `green_state`: high-level command (see table).
- `silver_line`: 0 or 1, indicates whether a silver line was detected in line mode.

## `green_state` Commands

These values come from `Main.py` and are used in `main.cpp`:

| Value | Detected by Raspberry | Effect on Teensy |
|---|---|---|
| 0 | Nothing special | Follows normal line (`action = 7`). |
| 1 | Green to the left | Turns left (`action = 6`). |
| 2 | Green to the right | Turns right (`action = 5`). |
| 3 | Double green | Half turn (`action = 14`). |
| 6 | Centered silver ball | Executes silver collection routine. |
| 7 | Centered black ball | Executes black collection routine. |
| 8 | Centered red zone | Deposits in red zone. |
| 9 | Green zone detected | Deposits in green zone. |
| 10 | Red line (in line) | On Raspberry, 10 is sent, but Teensy does not use 10 directly; it detects it as a visual event and follows its line logic. |

Notes:
- In rescue, `green_state` comes from YOLO detection.
- In line, `green_state` comes from the detection of green squares or red line.

## Messages Teensy -> Raspberry

The Teensy also sends bytes to change the state of the Raspberry program:

| Byte | When it is sent | Effect on Raspberry |
|---|---|---|
| `0xF9` (249) | When `startUp` ends | Changes from `waiting` to `line`. |
| `0xF8` (248) | When it has collected enough balls | Changes from `rescue` to `deposit`. |
| `0xFF` (255) | When the switch is turned off or canceled | Changes to `waiting`. |

## States of the Raspberry

The `Main.py` operates by states:
- `waiting`: waits for `0xF9` to start.
- `line`: line follower and detection of green/red/silver.
- `rescue`: detection of balls and approach.
- `deposit`: looks for deposit zones.
- `deposit green`: extra stage when detecting green zone.

Main transitions:
- `waiting` -> `line` when `0xF9` arrives.
- `line` -> `rescue` when a silver line is detected (`silver_line = 1`).
- `rescue` -> `deposit` when `0xF8` arrives.
- Any state -> `waiting` when `0xFF` arrives.

If the protocol or the order of the bytes is modified, both `Main.py` and `main.cpp` need to be updated.